# 機能仕様書: 注文機能

**フィーチャーブランチ**: `003-order-management`
**作成日**: 2026-02-09
**ステータス**: ドラフト
**入力**: 注文機能 — チェックアウト・注文確定、注文履歴・詳細、管理者の注文管理

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 — チェックアウトと注文確定（優先度: P1）

購入者として、カート内の商品を確認した上で注文を確定し、注文完了の確認を得たい。これにより商品の購入を完了できる。

**この優先度の理由**: 注文の作成はEC サイトの中核機能であり、これなしには売上が発生しない。最も高い優先度を持つ。

**独立テスト**: カートに商品を追加し、「注文手続きへ」ボタンからチェックアウト画面へ遷移、「注文を確定」で注文を作成し、注文完了画面に注文 ID とお礼メッセージが表示されることを確認する。注文後にカートが空になることも検証する。

**受入シナリオ**:

1. **Given** カートに商品がある状態、**When** 購入者が「注文手続きへ」ボタンをクリック、**Then** チェックアウト画面に遷移し、カート内の商品一覧（商品名・単価・数量・小計）と合計金額が表示される
2. **Given** チェックアウト画面を表示中、**When** 購入者が「注文を確定」ボタンをクリック、**Then** 注文が作成され、注文完了画面に注文 ID とお礼メッセージが表示される
3. **Given** 注文が確定した直後、**When** 購入者がカートページを開く、**Then** カートは空になっている
4. **Given** カートが空の状態、**When** 購入者がカートページを表示、**Then** 「注文手続きへ」ボタンは非表示になる
5. **Given** 未ログイン状態、**When** チェックアウト画面にアクセス、**Then** ログインページにリダイレクトされ、ログイン後に元のページに戻る

---

### ユーザーストーリー 2 — 購入者の注文履歴・注文詳細（優先度: P2）

購入者として、自分の過去の注文を一覧で確認し、各注文の詳細を閲覧したい。これにより注文状況の把握や確認ができる。

**この優先度の理由**: 注文後に購入者が注文内容やステータスを確認できることは、信頼性とユーザー体験に直結する。

**独立テスト**: 注文を作成済みの購入者でログインし、注文履歴ページで注文一覧が表示されること、注文詳細ページで注文情報が正しく表示されることを確認する。

**受入シナリオ**:

1. **Given** 注文が存在する購入者がログイン済み、**When** 注文履歴ページを開く、**Then** 自分の注文が一覧で表示される（注文 ID 先頭 8 桁・注文日・商品数・合計金額・ステータス）
2. **Given** 注文一覧を表示中、**When** 注文が 20 件を超える、**Then** ページネーションで 20 件ずつ表示される
3. **Given** 注文一覧を表示中、**When** 特定の注文をクリック、**Then** 注文詳細画面に遷移し、注文 ID・注文日時・ステータス・商品一覧・合計金額が表示される
4. **Given** 購入者 A がログイン中、**When** 購入者 B の注文詳細 URL に直接アクセス、**Then** アクセスが拒否される
5. **Given** 注文が存在しない購入者、**When** 注文履歴ページを開く、**Then** 「注文履歴がありません」メッセージが表示される

---

### ユーザーストーリー 3 — 管理者の注文一覧閲覧（優先度: P3）

管理者として、全ユーザーの注文を一覧で確認し、ステータスで絞り込みたい。これにより注文の運用管理ができる。

**この優先度の理由**: 管理者が注文を把握できなければ、ステータス更新（P4）も行えない。注文管理の基盤となる。

**独立テスト**: 管理者でログインし、注文管理ページで全注文が表示されること、ステータスでの絞り込みが動作することを確認する。

**受入シナリオ**:

1. **Given** 管理者がログイン済み、**When** 注文管理ページを開く、**Then** 全ユーザーの注文が一覧で表示される
2. **Given** 注文管理ページを表示中、**When** ステータスで絞り込む、**Then** 該当ステータスの注文のみ表示される
3. **Given** 購入者がログイン中、**When** 管理者の注文管理ページにアクセス、**Then** アクセスが拒否される

---

### ユーザーストーリー 4 — 管理者のステータス更新（優先度: P4）

管理者として、注文のステータスを更新したい。これにより注文の処理進行を管理し、購入者に最新状況を反映できる。

**この優先度の理由**: ステータス更新は注文管理一覧（P3）が前提。注文のライフサイクル管理に必須だが、閲覧機能の後に実装すべき。

**独立テスト**: 管理者でログインし、注文詳細からステータスを変更できること、遷移ルールに従わない変更が拒否されることを確認する。

**受入シナリオ**:

1. **Given** 管理者が「保留中」の注文を表示中、**When** ステータスを「確認済み」に変更、**Then** ステータスが更新され、一覧にも反映される
2. **Given** 管理者が「確認済み」の注文を表示中、**When** ステータスを「発送済み」に変更、**Then** ステータスが更新される
3. **Given** 管理者が「発送済み」の注文を表示中、**When** ステータスを「配送完了」に変更、**Then** ステータスが更新される
4. **Given** 管理者が「保留中」の注文を表示中、**When** ステータスを「キャンセル」に変更、**Then** ステータスが更新される
5. **Given** 管理者が「確認済み」の注文を表示中、**When** ステータスを「キャンセル」に変更、**Then** ステータスが更新される
6. **Given** 管理者が「配送完了」の注文を表示中、**When** ステータスを変更しようとする、**Then** 変更が拒否される（遷移不可）
7. **Given** 管理者が「キャンセル」の注文を表示中、**When** ステータスを変更しようとする、**Then** 変更が拒否される（遷移不可）

---

### エッジケース

- カートに商品がある状態で注文確定中に在庫が変動した場合はどうなるか？ → 注文作成時点のカート内容をそのまま使用する（在庫の再検証は本スコープ外）
- チェックアウト画面で「注文を確定」ボタンを連打した場合はどうなるか？ → 二重送信防止により、送信中はボタンを無効化する
- 注文確定後にブラウザバックでチェックアウト画面に戻った場合はどうなるか？ → カートが空のためチェックアウト不可の状態を表示する
- 管理者が存在しないステータス遷移を試みた場合はどうなるか？ → エラーメッセージを表示し、ステータスは変更されない
- 注文履歴が大量にある場合はどうなるか？ → 20 件/ページのページネーションで対応する

## 要件 *(必須)*

### 機能要件

**チェックアウトと注文確定**

- **FR-001**: カートに商品がある場合、カートページに「注文手続きへ」ボタンを表示しなければならない
- **FR-002**: カートが空の場合、「注文手続きへ」ボタンを非表示にしなければならない
- **FR-003**: チェックアウト画面で注文内容（商品名・単価・数量・小計・合計金額）を表示しなければならない
- **FR-004**: 「注文を確定」ボタンで注文を作成し、注文完了画面に注文 ID とお礼メッセージを表示しなければならない
- **FR-005**: 注文確定時に二重送信を防止しなければならない（送信中はボタンを無効化）
- **FR-006**: 注文作成後、カートを自動的にクリアしなければならない
- **FR-007**: 注文金額にはカートの税抜小計を使用しなければならない

**購入者の注文履歴・注文詳細**

- **FR-008**: 購入者は自分の注文のみを一覧で確認できなければならない
- **FR-009**: 注文一覧には注文 ID 先頭 8 桁・注文日・商品数・合計金額・ステータスを表示しなければならない
- **FR-010**: 注文一覧は 20 件/ページのページネーションを提供しなければならない
- **FR-011**: 注文詳細画面で注文 ID・注文日時・ステータス・商品一覧・合計金額を表示しなければならない
- **FR-012**: 購入者は他人の注文にアクセスできてはならない

**管理者の注文管理**

- **FR-013**: 管理者は全ユーザーの注文を一覧で確認できなければならない
- **FR-014**: 管理者はステータスで注文を絞り込めなければならない
- **FR-015**: 管理者は以下のステータス遷移ルールに従ってステータスを更新できなければならない
  - 保留中 → 確認済み、キャンセル
  - 確認済み → 発送済み、キャンセル
  - 発送済み → 配送完了
  - 配送完了 → 遷移不可
  - キャンセル → 遷移不可
- **FR-016**: 購入者は管理者の注文管理ページにアクセスできてはならない

**認証・認可**

- **FR-017**: チェックアウトおよび注文関連ページには購入者（buyer）ログインが必須である
- **FR-018**: 管理者の注文管理ページには管理者（admin）ログインが必須である
- **FR-019**: 未ログイン時はログインページにリダイレクトし、ログイン後に元のページに戻らなければならない

### 主要エンティティ

- **注文（Order）**: 注文 ID、購入者 ID、注文日時、ステータス（保留中・確認済み・発送済み・配送完了・キャンセル）、注文明細のリスト、合計金額
- **注文明細（OrderItem）**: 商品 ID、商品名、単価、数量、小計
- **ステータス遷移**: 保留中 → 確認済み → 発送済み → 配送完了（保留中・確認済みからキャンセル可能、配送完了・キャンセルからの遷移不可）

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 購入者がカートから注文完了までを 3 ステップ以内（カート → チェックアウト → 完了）で完了できる
- **SC-002**: 注文履歴ページで自分の注文一覧が 2 秒以内に表示される
- **SC-003**: 管理者がステータス更新を 1 回の操作で完了でき、一覧に即時反映される
- **SC-004**: 購入者が他人の注文にアクセスした場合、100% の確率でアクセスが拒否される
- **SC-005**: 不正なステータス遷移が 100% の確率で拒否される
- **SC-006**: 注文確定時の二重送信が 100% 防止される

## スコープ外

- 決済処理（クレジットカード、銀行振込等）
- 配送先住所の入力・管理
- 購入者によるキャンセル機能（キャンセルは管理者のみ）
- 注文のメール通知
- 在庫の再検証（注文確定時のリアルタイム在庫チェック）

## 前提条件

- カート機能（002-cart-management）が実装済みであること
- セッションベースの認証機能が実装済みであること
- 購入者（buyer）と管理者（admin）の 2 つのロールが存在すること
- 消費税は一律 10%（軽減税率対象外）、ただし注文金額にはカートの税抜小計を使用する
- 注文データの永続化はインメモリとし、データベース永続化は将来フェーズとする
- 新規注文のステータスは「保留中」で作成される
