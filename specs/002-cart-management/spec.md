# 機能仕様書: カート管理機能

**フィーチャーブランチ**: `002-cart-management`
**作成日**: 2026-02-09
**ステータス**: ドラフト
**入力**: 購入者が商品をカートに追加し、購入前に内容を確認・編集できる機能

## ユーザーシナリオとテスト

### ユーザーストーリー 1 — カートに商品を追加する（優先度: P1）

購入者として、商品詳細ページから「カートに追加」ボタンを押して商品をカートに入れたい。追加後にフィードバックを受け取り、ヘッダーのカートアイコンで現在のカート内商品数を確認したい。

**優先度の理由**: カート機能の最も基本的な操作であり、他のすべてのカート操作（確認・数量変更・削除）の前提条件となる。これがなければカート機能は成立しない。

**独立テスト**: 商品詳細ページからカート追加ボタンを押し、成功フィードバックが表示されること、ヘッダーのカートアイコンの件数が更新されることを確認する。同一商品を再度追加した場合に数量が増加することを検証する。

**受入シナリオ**:

1. **前提** ログイン済みの購入者が在庫ありの商品詳細ページを表示している、**操作** 「カートに追加」ボタンを押す、**結果** 商品がカートに追加され、成功フィードバックが表示され、ヘッダーのカートアイコンの件数が1増加する
2. **前提** カートに商品Aが1個入っている、**操作** 商品Aの詳細ページで再度「カートに追加」ボタンを押す、**結果** 商品Aの数量が2に増加する（重複追加されない）
3. **前提** 在庫切れの商品詳細ページを表示している、**操作** ページを確認する、**結果** 「カートに追加」ボタンが無効化されており、押すことができない
4. **前提** 「カートに追加」ボタンを押した直後、**操作** もう一度ボタンを押す、**結果** 二重送信が防止され、リクエストは1回だけ処理される
5. **前提** 未ログインの状態で商品詳細ページを表示している、**操作** 「カートに追加」ボタンを押す、**結果** ログインページにリダイレクトされ、ログイン後に元の商品詳細ページに戻る

---

### ユーザーストーリー 2 — カート内容を確認する（優先度: P2）

購入者として、カートページで現在カートに入っている商品の一覧を確認したい。各商品の画像・名前・単価・数量・小計と、商品合計・消費税・総合計を確認して購入判断をしたい。

**優先度の理由**: カートに追加した商品の確認は購入判断に直結する重要機能。カート追加の次に必要となるユーザージャーニーである。

**独立テスト**: カートに商品を追加した後、カートページにアクセスし、商品一覧と金額明細が正しく表示されることを確認する。空のカートでは適切なメッセージと商品一覧への導線が表示されることを検証する。

**受入シナリオ**:

1. **前提** カートに商品が1件以上入っている、**操作** カートページを開く、**結果** 各商品の商品画像・商品名・単価・数量・小計が一覧表示され、商品合計・消費税（10%、端数切り捨て）・総合計が表示される
2. **前提** カートに商品A（¥1,000 x 2）と商品B（¥3,000 x 1）が入っている、**操作** カートページの合計欄を確認する、**結果** 商品合計: ¥5,000、消費税: ¥500、総合計: ¥5,500 が表示される
3. **前提** カートが空である、**操作** カートページを開く、**結果** 「カートに商品がありません」メッセージと商品一覧ページへのリンクが表示される
4. **前提** カートに商品が入っている、**操作** ヘッダーのカートアイコンをクリックする、**結果** カートページに遷移する

---

### ユーザーストーリー 3 — カート内の数量を変更する（優先度: P3）

購入者として、カートページで商品の購入数量を変更したい。数量変更後に小計と合計金額が即座に更新されることを確認したい。

**優先度の理由**: カート内容の調整は購入フローにおいて頻繁に行われる操作であり、数量変更なしでは購入量の修正が商品削除→再追加の手順となり使い勝手が悪い。

**独立テスト**: カートページで商品の数量を変更し、小計と合計が即時更新されることを確認する。範囲外の数量や在庫超過の入力に対してエラーが表示されることを検証する。

**受入シナリオ**:

1. **前提** カートに商品A（¥1,000 x 1）が入っている、**操作** 数量を3に変更する、**結果** 小計が¥3,000に更新され、合計金額も即時更新される
2. **前提** カートに在庫数5の商品がある、**操作** 数量を6に変更しようとする、**結果** 変更が拒否され「在庫数を超えています」エラーメッセージが表示される
3. **前提** カートに商品がある、**操作** 数量を0以下に変更しようとする、**結果** 変更が拒否される（数量の最小値は1）
4. **前提** カートに商品がある、**操作** 数量を100以上に変更しようとする、**結果** 変更が拒否される（数量の最大値は99）

---

### ユーザーストーリー 4 — カートから商品を削除する（優先度: P4）

購入者として、カートから不要な商品を削除したい。誤操作を防ぐため、削除前に確認を求められたい。

**優先度の理由**: 不要な商品の削除はカート管理の基本操作。確認ダイアログにより誤操作を防止し、ユーザー体験を向上させる。

**独立テスト**: カートページで商品の削除ボタンを押し、確認ダイアログが表示されること、確認後に商品が削除されること、最後の商品削除で空状態になることを検証する。

**受入シナリオ**:

1. **前提** カートに商品が2件以上入っている、**操作** 1件の商品の削除ボタンを押す、**結果** 確認ダイアログが表示される
2. **前提** 確認ダイアログが表示されている、**操作** 「削除する」を選択する、**結果** 商品がカートから削除され、合計金額が更新される
3. **前提** 確認ダイアログが表示されている、**操作** 「キャンセル」を選択する、**結果** 商品は削除されず、カートの状態は変わらない
4. **前提** カートに商品が1件だけ入っている、**操作** その商品を削除する、**結果** カートが空になり、「カートに商品がありません」メッセージが表示される

---

### ユーザーストーリー 5 — カート内容の永続化（優先度: P5）

購入者として、ページ遷移やブラウザリロード後もカートの内容が保持されていてほしい。

**優先度の理由**: カート内容が消失するとユーザーの不満に直結する。ただし基本的なCRUD操作（US1〜US4）が先に成立している必要がある。

**独立テスト**: カートに商品を追加した後、ページを遷移して戻る、またはブラウザをリロードし、カートの内容が維持されていることを確認する。

**受入シナリオ**:

1. **前提** カートに商品が入っている、**操作** 他のページに遷移してからカートページに戻る、**結果** カートの内容（商品・数量）が保持されている
2. **前提** カートに商品が入っている、**操作** ブラウザをリロードする、**結果** カートの内容（商品・数量）が保持されている

---

### エッジケース

- カートに追加しようとした商品が追加操作中に在庫切れになった場合はどうなるか？ → エラーメッセージ「在庫が不足しています」を表示し、カートには追加しない
- カート内の商品が他の購入者により在庫切れになった場合はどうなるか？ → カートページ表示時に在庫チェックを行い、在庫超過分は警告を表示する
- 同時に複数タブでカート操作を行った場合はどうなるか？ → サーバー側のカートデータを正とし、最後の操作が反映される
- ログインセッションが切れた状態でカート操作を行った場合はどうなるか？ → ログインページにリダイレクトし、ログイン後に元のページに戻る
- 消費税計算で端数が発生した場合はどうなるか？ → 商品合計に対して10%を乗じ、端数は切り捨てる（例: 商品合計¥1,999 → 消費税¥199）

## 要件

### 機能要件

**カート追加**:

- **FR-001**: システムは、ログイン済み購入者が商品詳細ページから「カートに追加」ボタンで商品をカートに追加できなければならない
- **FR-002**: システムは、カートに既に存在する商品を再度追加した場合、新たな行を作らず数量を1増加させなければならない
- **FR-003**: システムは、在庫切れ（在庫数0）の商品に対して「カートに追加」ボタンを無効化しなければならない
- **FR-004**: システムは、カート追加ボタンの二重送信を防止しなければならない（送信中はボタンを無効化する）
- **FR-005**: システムは、カート追加成功時にユーザーにフィードバック（成功メッセージ）を表示しなければならない
- **FR-006**: システムは、カート追加成功時にヘッダーのカートアイコンの件数をリアルタイムで更新しなければならない

**カート表示**:

- **FR-007**: システムは、カートページで各商品の商品画像・商品名・単価・数量・小計を一覧表示しなければならない
- **FR-008**: システムは、カートページで商品合計・消費税（10%、端数切り捨て）・総合計を表示しなければならない
- **FR-009**: システムは、カートが空の場合に「カートに商品がありません」メッセージと商品一覧ページへの導線を表示しなければならない

**数量変更**:

- **FR-010**: システムは、カート内の商品数量を1〜99の範囲で変更できなければならない
- **FR-011**: システムは、在庫数を超える数量への変更を拒否し、エラーメッセージ「在庫数を超えています」を表示しなければならない
- **FR-012**: システムは、数量変更時に小計と合計金額を即時更新しなければならない

**商品削除**:

- **FR-013**: システムは、カートから商品を削除する前に確認ダイアログを表示しなければならない
- **FR-014**: システムは、確認ダイアログで「削除する」を選択した場合にのみ商品を削除しなければならない
- **FR-015**: システムは、最後の商品を削除した場合にカート空状態メッセージを表示しなければならない

**永続化**:

- **FR-016**: システムは、カートの内容をページ遷移やブラウザリロード後も保持しなければならない

**認証**:

- **FR-017**: システムは、未ログイン状態でのカート操作時にログインページへリダイレクトし、ログイン後に元のページへ戻さなければならない

### 主要エンティティ

- **カート（Cart）**: 購入者ごとに1つ存在する買い物かご。購入者ID、カート内商品のリスト、作成日時、更新日時を持つ
- **カートアイテム（CartItem）**: カート内の1商品。商品への参照、数量（1〜99）、追加日時を持つ。同一商品は1つのカートアイテムに集約される
- **商品（Product）**: カタログ機能で管理される既存エンティティ。カートアイテムから参照される（商品名・価格・在庫数・画像URL）

## 成功基準

### 測定可能な成果

- **SC-001**: 購入者が商品詳細ページからカートに商品を追加する操作を3秒以内に完了でき、成功フィードバックが表示される
- **SC-002**: カートページで商品合計・消費税・総合計の計算が正確であり、端数処理（切り捨て）が仕様通りに動作する
- **SC-003**: 数量変更操作後、1秒以内に小計と合計金額が更新される
- **SC-004**: ページ遷移およびブラウザリロード後にカート内容が100%保持される
- **SC-005**: 未ログインユーザーがカート操作を試みた場合、100%の確率でログインページにリダイレクトされ、ログイン後に元ページに戻れる
- **SC-006**: 在庫切れ商品のカート追加ボタンが確実に無効化され、在庫超過の数量変更が確実に拒否される

## スコープ外

- 注文確定・決済処理（将来フェーズ）
- カートのDB永続化（現フェーズはインメモリ）
- 複数カート・ウィッシュリストの管理
- クーポン・割引の適用
- 配送先の入力・配送料の計算
- 軽減税率（消費税は一律10%）

## 前提条件

- カタログ閲覧機能（001-catalog-listing）が実装済みであること
- 購入者認証（ログイン・ログアウト）機能がシステムに存在すること
- 消費税率は一律10%（軽減税率対象外）とする
- カートの永続化はサーバーサイドのインメモリストアで実現する（DB永続化は将来フェーズ）
- カートは購入者ごとに1つ（複数カートは対象外）
- 数量の範囲は1〜99とする
